name: Build and Publish Docker Image (Main)

on:
  push:
    branches: [ staging ]
  workflow_dispatch:

jobs:
  # Build docker image and publish it to GitHub Container Registry
  docker-bugfix:
    name: Publish bugfix branch to GitHub registry
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: staging

      - name: Login to GitHub Container Registry
        run: echo ${{ github.token }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build docker image
        run: docker build -t ghcr.io/${{ github.repository_owner }}/metrics:staging .

      - name: Publish to GitHub Container Registry
        run: docker push ghcr.io/${{ github.repository_owner }}/metrics:staging

      - name: Tag as branch name
        run: |
          docker tag ghcr.io/${{ github.repository_owner }}/metrics:staging
          docker push ghcr.io/${{ github.repository_owner }}/metrics:staging

      - name: Summary
        run: |
          echo "âœ… Docker image published successfully!"
          echo ""
          echo "**Image tags:**"
          echo "- \`ghcr.io/${{ github.repository_owner }}/metrics:staging\`"
          echo ""
          echo "**Usage in GitHub Actions:**"
          echo "\`\`\`yaml"
          echo "uses: docker://ghcr.io/${{ github.repository_owner }}/metrics:staging"
          echo "\`\`\`"
